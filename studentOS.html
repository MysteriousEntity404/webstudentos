<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudentOS - Dashboard IA & Productivité</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .task-card { transition: all 0.3s ease; }
        .task-card:hover { transform: translateY(-2px); border-color: #3b82f6; }
        .prose h1, .prose h2, .prose h3 { color: #fff; margin-top: 1em; margin-bottom: 0.5em; font-weight: bold; }
        .prose p { margin-bottom: 0.8em; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .prose strong { color: #93c5fd; }
        .prose code { background: #334155; padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; color: #e2e8f0; font-size: 0.9em; }
        .prose pre { background: #1e293b; padding: 1em; border-radius: 8px; overflow-x: auto; margin-bottom: 1em; border: 1px solid #475569; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.7;
            cursor: pointer;
        }
        .ai-accent {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
        }
        .tool-btn {
            @apply flex items-center justify-center w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-gray-300 transition-colors border border-gray-600 hover:border-blue-400;
        }
        /* Toggle Switch Style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- NAVIGATION -->
    <nav class="glass sticky top-0 z-50 px-6 py-4 flex flex-col md:flex-row justify-between items-center border-b border-gray-700 gap-4 md:gap-0">
        <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-xl text-white shadow-lg shadow-blue-500/50">S</div>
                <h1 class="text-xl font-bold tracking-tight text-white">Student<span class="text-blue-400">OS</span></h1>
            </div>
            
            <!-- FEATURE: PRIORISATEUR (Mobile visible) -->
            <button onclick="askAI('prioritize', null)" class="md:hidden bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-lg shadow-orange-500/20 flex items-center gap-2 animate-pulse">
                <i class="fas fa-bolt"></i> Que faire ?
            </button>
        </div>

        <div class="flex gap-4 items-center flex-wrap justify-end w-full md:w-auto">
            
            <!-- FEATURE: PRIORISATEUR (Desktop) -->
            <button onclick="askAI('prioritize', null)" class="hidden md:flex bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg shadow-orange-500/20 items-center gap-2 transition transform hover:scale-105">
                <i class="fas fa-bolt"></i> Que faire maintenant ?
            </button>

            <!-- TOGGLE MODE PREMIUM -->
            <div class="flex items-center gap-2 mr-2 border-r border-gray-700 pr-4">
                <label for="premiumToggle" class="flex items-center cursor-pointer relative">
                    <input type="checkbox" id="premiumToggle" class="sr-only" onchange="togglePremiumMode()">
                    <div class="w-10 h-5 bg-gray-700 rounded-full shadow-inner border border-gray-600 toggle-bg transition-colors duration-300"></div>
                    <div class="dot absolute left-1 top-1 bg-white w-3 h-3 rounded-full shadow transition-transform duration-300 transform translate-x-0"></div>
                </label>
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider" id="premiumLabel">Gratuit</span>
            </div>

            <div class="hidden md:flex flex-col items-end opacity-60 relative group">
                <div id="apiKeyAlert" class="absolute bg-red-800/80 text-white text-[10px] p-1 rounded -top-8 right-0 hidden">Clé API manquante !</div>
                <input type="password" id="apiKeyInput" 
                       value="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" 
                       oninput="checkApiKey()"
                       placeholder="Clé OpenRouter (sk-or...)"
                       class="bg-gray-800 border border-gray-600 text-xs text-gray-400 rounded px-3 py-1 w-32 focus:w-64 text-right focus:outline-none focus:ring-1 focus:ring-blue-500 transition-all duration-300">
                <span class="text-[9px] text-gray-500 group-hover:text-blue-400 cursor-help" title="Nécessaire pour les fonctions IA">Configuration API</span>
            </div>
            <div class="flex items-center gap-2 px-4 py-2 bg-gray-800 rounded-full border border-gray-700 shadow-inner">
                <span class="w-2 w-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_10px_#22c55e]"></span>
                <span class="text-sm font-medium">Connecté</span>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <!-- SIDEBAR -->
        <aside class="w-64 bg-slate-900 border-r border-gray-800 hidden md:flex flex-col p-6 gap-6 overflow-y-auto">
            
            <div class="glass p-5 rounded-xl text-center shadow-lg bg-slate-800/50">
                <h3 class="text-gray-300 text-sm uppercase tracking-wider mb-3 font-bold flex items-center gap-2"><i class="fas fa-plus-circle text-blue-400"></i> Ajouter un Devoir</h3>
                <button onclick="openFormModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium w-full transition shadow-lg shadow-blue-600/30">
                    Nouveau Devoir
                </button>
            </div>

            <div class="glass p-5 rounded-xl shadow-lg bg-slate-800/50 border border-emerald-600/50">
                <h3 class="text-sm uppercase tracking-wider mb-4 font-bold flex items-center gap-2 text-emerald-400"><i class="fas fa-brain"></i> Mon Style d'Apprentissage</h3>
                <select id="learningStyle" onchange="saveLearningStyle()" class="w-full px-4 py-2 bg-slate-800 border border-gray-600 rounded-lg text-white focus:ring-emerald-500 focus:border-emerald-500 text-sm">
                    <option value="VISUEL">VISUEL (Yeux)</option>
                    <option value="AUDITIF">AUDITIF (Oreilles)</option>
                    <option value="KINESTHESIQUE">KINESTHÉSIQUE (Mains)</option>
                    <option value="MIXTE">MIXTE (Neutre)</option>
                </select>
                <p class="text-[10px] text-gray-500 mt-2 italic" id="styleTip">Sélectionnez votre préférence.</p>
            </div>
            
            <div class="glass p-5 rounded-xl text-center shadow-lg bg-slate-800/50">
                <h3 class="text-gray-300 text-sm uppercase tracking-wider mb-4 font-bold flex items-center justify-center gap-2">
                    <i class="fas fa-chart-line text-green-400"></i> Vue de Progression
                </h3>
                
                <div id="progressionBarContainer" class="w-full mb-4 text-left"></div>
                
                <button onclick="askAIDashboardAnalysis()" class="ai-accent hover:bg-blue-500 text-white px-3 py-2 rounded-lg text-xs font-medium w-full transition flex items-center justify-center gap-2">
                    <i class="fas fa-magic"></i> Analyser mes notes
                </button>
            </div>

            <div class="glass p-5 rounded-xl shadow-lg bg-slate-800/50 border border-gray-700">
                <h3 class="text-gray-300 text-sm uppercase tracking-wider mb-3 font-bold flex items-center gap-2"><i class="fas fa-filter text-indigo-400"></i> Filtrer par Matière</h3>
                <div class="grid grid-cols-2 gap-2 text-sm" id="filterButtonsContainer"></div>
            </div>
            
            <!-- FEATURE: TIMER & MUSIC -->
            <div class="glass p-5 rounded-xl text-center shadow-lg bg-slate-800/50">
                <h3 class="text-gray-400 text-xs uppercase tracking-wider mb-2 font-bold">Focus Timer</h3>
                <div id="timerDisplay" class="text-5xl font-mono font-bold text-white mb-4 drop-shadow-md">25:00</div>
                <div class="flex justify-center gap-3 mb-3">
                    <button onclick="toggleTimer()" id="timerBtn" class="bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 rounded-full flex items-center justify-center transition shadow-lg shadow-blue-600/30"><i class="fas fa-play ml-1"></i></button>
                    <button onclick="resetTimer()" class="bg-slate-700 hover:bg-slate-600 text-white w-10 h-10 rounded-full flex items-center justify-center transition"><i class="fas fa-redo"></i></button>
                </div>
                <!-- FEATURE: MUSIC SUGGESTION -->
                <button onclick="askAI('music', null)" class="text-[10px] text-blue-300 hover:text-white underline decoration-dashed flex items-center justify-center gap-1 mx-auto">
                    <i class="fas fa-headphones-alt"></i> Suggérer une ambiance sonore
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth bg-gradient-to-br from-[#0f172a] to-[#1e1b4b]">
            <header class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-end">
                <div>
                    <h2 class="text-4xl font-bold text-white mb-2">Devoirs à Faire</h2>
                    <p class="text-gray-400 text-lg">Tu as <span id="taskCount" class="text-white font-bold">0</span> tâches restantes.</p>
                </div>
                <!-- Mobile Only Add Button -->
                <button onclick="openFormModal()" class="md:hidden mt-4 w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg">
                    + Ajouter un devoir
                </button>
            </header>
            
            <p id="emptyMessage" class="text-center text-gray-500 py-10">
                <i class="fas fa-inbox text-4xl mb-4"></i><br>
                C'est vide ! Utilise le bouton **"Ajouter un Devoir"** pour commencer.
            </p>

            <div id="taskContainer" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 pb-20">
                <!-- Les tâches sont injectées ici par JS -->
            </div>
        </main>
    </div>

    <!-- MODAL FORMULAIRE -->
    <div id="formModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[70] flex items-center justify-center opacity-0 transition-opacity duration-300">
        <form id="addHomeworkForm" class="bg-slate-900 border border-gray-700 w-full max-w-lg rounded-2xl shadow-2xl flex flex-col transform transition-all scale-95 duration-300 m-4">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-slate-800/80 rounded-t-2xl">
                <h3 class="text-xl font-bold text-white" id="formModalTitle"><i class="fas fa-pencil-alt text-blue-400 mr-2"></i> Ajouter une Nouvelle Tâche</h3>
                <button type="button" onclick="closeFormModal()" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-gray-300 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label for="taskTitle" class="block text-sm font-medium text-gray-400 mb-1">Titre de la tâche (ex: Ex 69 p 57)</label>
                    <input type="text" id="taskTitle" name="taskTitle" required class="w-full px-4 py-2 bg-slate-800 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="taskSubject" class="block text-sm font-medium text-gray-400 mb-1">Matière</label>
                    <select id="taskSubject" name="taskSubject" required class="w-full px-4 py-2 bg-slate-800 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500">
                        <option value="MATHÉMATIQUES">MATHÉMATIQUES</option>
                        <option value="FRANÇAIS">FRANÇAIS</option>
                        <option value="PHYSIQUE-CHIMIE">PHYSIQUE-CHIMIE</option>
                        <option value="ANGLAIS">ANGLAIS</option>
                        <option value="HISTOIRE-GÉO">HISTOIRE-GÉO</option>
                        <option value="AUTRE">AUTRE</option>
                    </select>
                </div>
                <div>
                    <label for="taskDueDate" class="block text-sm font-medium text-gray-400 mb-1">Date d'échéance (Optionnel)</label>
                    <input type="date" id="taskDueDate" name="taskDueDate" class="w-full px-4 py-2 bg-slate-800 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="taskDescription" class="block text-sm font-medium text-gray-400 mb-1">Description / Instructions</label>
                    <textarea id="taskDescription" name="taskDescription" rows="3" required class="w-full px-4 py-2 bg-slate-800 border border-gray-600 rounded-lg text-white focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>

            <div class="p-4 border-t border-gray-700 bg-slate-800/50 rounded-b-2xl flex justify-end">
                <button type="submit" id="formSubmitButton" class="bg-blue-600 hover:bg-blue-500 text-white font-medium px-5 py-2 rounded-lg transition flex items-center gap-2">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </div>
        </form>
    </div>

    <!-- MODAL IA -->
    <div id="aiModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-[60] flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-slate-900 border border-gray-700 w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[85vh] mx-4 transform transition-all scale-95 duration-300">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-slate-800/80 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <i class="fas fa-robot text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white">Assistant Virtuel</h3>
                        <p id="aiStatus" class="text-xs text-blue-300">Prêt à aider</p>
                    </div>
                </div>
                <button type="button" onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 text-gray-300 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1 bg-slate-900/50">
                <div id="aiLoading" class="hidden flex flex-col items-center justify-center py-12">
                    <div class="relative w-16 h-16 mb-4">
                        <div class="absolute top-0 left-0 w-full h-full border-4 border-slate-700 rounded-full"></div>
                        <div class="absolute top-0 left-0 w-full h-full border-4 border-t-blue-500 border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin"></div>
                    </div>
                    <p class="text-gray-300 font-medium animate-pulse">L'IA réfléchit...</p>
                    <p id="retryMessage" class="text-xs text-gray-500 mt-2 h-4"></p>
                    <div id="timerDisplayAI" class="text-xl font-mono text-blue-400 mt-4">--:--</div>
                </div>
                
                <div id="aiContent" class="prose prose-invert max-w-none text-sm text-gray-300">
                </div>
            </div>
            
            <div class="p-3 border-t border-gray-800 bg-slate-900 rounded-b-2xl text-[10px] text-center text-gray-600 uppercase tracking-widest">
                System: Gemini Flash / Llama 3 / Mistral
            </div>
        </div>
    </div>

    <script>
        // --- DONNÉES ET CONFIGURATION ---
        let tasks = []; 
        let nextTaskId = 1; 
        let currentFilter = null; 
        let editingTaskId = null; 
        let currentChartData = {};

        const SUBJECT_COLORS = {
            'MATHÉMATIQUES': { color: 'border-blue-500', badge: 'bg-blue-500/10 text-blue-400', icon: 'fa-calculator' },
            'FRANÇAIS': { color: 'border-red-500', badge: 'bg-red-500/10 text-red-400', icon: 'fa-book-open' },
            'PHYSIQUE-CHIMIE': { color: 'border-purple-500', badge: 'bg-purple-500/10 text-purple-400', icon: 'fa-flask' },
            'ANGLAIS': { color: 'border-green-500', badge: 'bg-green-500/10 text-green-400', icon: 'fa-language' },
            'HISTOIRE-GÉO': { color: 'border-yellow-500', badge: 'bg-yellow-500/10 text-yellow-400', icon: 'fa-globe-europe' },
            'AUTRE': { color: 'border-gray-500', badge: 'bg-gray-500/10 text-gray-400', icon: 'fa-tasks' }
        };

        // --- GESTION DU STORAGE ---
        function loadTasks() {
            const savedTasks = localStorage.getItem('homeworkTasks');
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
                const maxId = tasks.reduce((max, task) => Math.max(max, task.id), 0);
                nextTaskId = maxId + 1;
            } else {
                tasks = []; 
                nextTaskId = 1;
            }
        }

        function saveTasks() {
            localStorage.setItem('homeworkTasks', JSON.stringify(tasks));
        }
        
        // --- GESTION DU STYLE D'APPRENTISSAGE ---
        let learningStyle = localStorage.getItem('learningStyle') || 'MIXTE';

        function saveLearningStyle() {
            const selectElement = document.getElementById('learningStyle');
            if (selectElement) {
                learningStyle = selectElement.value;
                localStorage.setItem('learningStyle', learningStyle);
                updateLearningStyleUI();
            }
        }

        function updateLearningStyleUI() {
            const selectElement = document.getElementById('learningStyle');
            const tipElement = document.getElementById('styleTip');
            if (selectElement) selectElement.value = learningStyle;
            
            let tip = "Sélectionnez votre préférence dominante.";
            if(learningStyle === 'VISUEL') tip = "L'IA favorisera les schémas et listes à puces.";
            else if(learningStyle === 'AUDITIF') tip = "L'IA favorisera les explications narratives.";
            else if(learningStyle === 'KINESTHESIQUE') tip = "L'IA proposera des étapes pratiques.";
            
            if (tipElement) tipElement.textContent = tip;
        }
        
        // --- PREMIUM MODE TOGGLE ---
        let isPremiumMode = localStorage.getItem('isPremiumMode') === 'true';
        
        function togglePremiumMode() {
            const checkbox = document.getElementById('premiumToggle');
            const label = document.getElementById('premiumLabel');
            const dot = checkbox.nextElementSibling.nextElementSibling;
            
            isPremiumMode = checkbox.checked;
            localStorage.setItem('isPremiumMode', isPremiumMode);
            
            if (isPremiumMode) {
                label.textContent = "PREMIUM ⚡";
                label.classList.replace('text-gray-400', 'text-blue-400');
                dot.classList.add('translate-x-5');
                checkbox.nextElementSibling.classList.replace('bg-gray-700', 'bg-blue-600');
            } else {
                label.textContent = "GRATUIT";
                label.classList.replace('text-blue-400', 'text-gray-400');
                dot.classList.remove('translate-x-5');
                checkbox.nextElementSibling.classList.replace('bg-blue-600', 'bg-gray-700');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const checkbox = document.getElementById('premiumToggle');
            if(checkbox) {
                checkbox.checked = isPremiumMode;
                togglePremiumMode(); // Init UI
            }
        });

        // --- UI HELPERS ---
        function getUrgencyStatus(dueDate) {
            if (!dueDate) return { badge: 'bg-gray-500/20 text-gray-400', text: 'Pas de date' };
            const today = new Date(); today.setHours(0,0,0,0);
            const due = new Date(dueDate); due.setHours(0,0,0,0);
            const diffTime = due.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return { badge: 'bg-red-700/50 text-red-300 border border-red-500', text: 'EN RETARD' };
            if (diffDays === 0) return { badge: 'bg-red-600/50 text-red-300 border border-red-500', text: 'AUJOURD\'HUI' };
            if (diffDays === 1) return { badge: 'bg-red-500/40 text-red-300 border border-red-500', text: 'DEMAIN' };
            if (diffDays <= 3) return { badge: 'bg-yellow-600/40 text-yellow-300 border border-yellow-500', text: `J-${diffDays}` };
            return { badge: 'bg-green-700/30 text-green-300 border border-green-500', text: `J-${diffDays}` };
        }

        function renderFilterButtons() {
            const container = document.getElementById('filterButtonsContainer');
            if (!container) return; 
            container.innerHTML = '';
            
            const totalRemaining = tasks.filter(t => !t.done).length;
            container.insertAdjacentHTML('beforeend', `
                <button onclick="renderTasks(null)" class="col-span-2 bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-md transition font-medium text-xs ${currentFilter === null ? 'ring-2 ring-blue-500' : ''}">
                    TOUT (${totalRemaining})
                </button>
            `);

            Object.keys(SUBJECT_COLORS).forEach(subj => {
                const count = tasks.filter(t => t.subject === subj && !t.done).length;
                if (count > 0) {
                    container.insertAdjacentHTML('beforeend', `
                        <button onclick="renderTasks('${subj}')" class="bg-slate-700 hover:bg-slate-600 text-gray-300 px-3 py-1 rounded-md transition font-medium text-xs border ${SUBJECT_COLORS[subj].color} ${currentFilter === subj ? 'ring-2 ring-blue-500' : ''}">
                            ${subj.substring(0, 3)}. (${count})
                        </button>
                    `);
                }
            });
        }

        // --- RENDER TASKS ---
        function renderTasks(filterSubject = currentFilter) {
            currentFilter = filterSubject;
            const container = document.getElementById('taskContainer');
            const emptyMessage = document.getElementById('emptyMessage');
            
            if (!container) return;
            
            const globalRemainingTasks = tasks.filter(t => !t.done).length;
            document.getElementById('taskCount').textContent = globalRemainingTasks; 

            let filteredTasks = tasks
                .filter(t => !currentFilter || t.subject === currentFilter)
                .sort((a, b) => {
                    if (a.done !== b.done) return a.done ? 1 : -1; 
                    const dateA = a.due_date ? new Date(a.due_date) : new Date(8640000000000000); 
                    const dateB = b.due_date ? new Date(b.due_date) : new Date(8640000000000000);
                    return dateA - dateB;
                });

            container.innerHTML = ''; 
            emptyMessage.style.display = (tasks.length === 0 || filteredTasks.length === 0) ? 'block' : 'none';
            container.style.display = (tasks.length === 0 || filteredTasks.length === 0) ? 'none' : 'grid'; 

            filteredTasks.forEach(task => {
                const colors = SUBJECT_COLORS[task.subject] || SUBJECT_COLORS['AUTRE'];
                const urgency = getUrgencyStatus(task.due_date);
                const isDisabled = task.done ? 'opacity-50 pointer-events-none' : '';

                const html = `
                    <div class="glass task-card rounded-xl p-5 border-l-4 ${colors.color} flex flex-col h-full relative group shadow-lg shadow-black/20 ${task.done ? 'opacity-50' : ''}">
                        
                        <!-- Header Carte -->
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-[10px] font-bold tracking-widest px-2 py-1 rounded uppercase ${colors.badge} border border-current">
                                <i class="fas ${colors.icon} mr-2"></i>${task.subject}
                            </span>
                            <div class="relative">
                                <input type="checkbox" ${task.done ? 'checked' : ''} onchange="toggleTaskDone(${task.id})" class="peer appearance-none w-5 h-5 border-2 border-gray-600 rounded bg-slate-800 checked:bg-blue-600 checked:border-blue-600 cursor-pointer">
                                <i class="fas fa-check text-white absolute top-0.5 left-1 opacity-0 peer-checked:opacity-100 pointer-events-none text-xs"></i>
                            </div>
                        </div>

                        <!-- Contenu Principal -->
                        <div class="flex-1 mb-4">
                            <h3 class="text-lg font-bold text-white mb-2 leading-tight">${task.title}</h3>
                            <p class="text-gray-400 text-xs leading-relaxed line-clamp-3">${task.description}</p>
                        </div>

                        <!-- AI Tools Bar (NOUVEAU) -->
                        <div class="flex gap-2 mb-4 pt-3 border-t border-gray-700/50 justify-center ${isDisabled}">
                            <button onclick="askAI('eli5', ${task.id})" class="tool-btn" title="Vulgariser (Explain Like I'm 5)">
                                <i class="fas fa-baby"></i>
                            </button>
                            <button onclick="askAI('quiz', ${task.id})" class="tool-btn" title="Générer un Quiz">
                                <i class="fas fa-brain"></i>
                            </button>
                            <button onclick="askAI('breakdown', ${task.id})" class="tool-btn" title="Découper la tâche">
                                <i class="fas fa-cut"></i>
                            </button>
                             <button onclick="askAI('estimate', ${task.id})" class="tool-btn" title="Estimer le temps">
                                <i class="fas fa-stopwatch"></i>
                            </button>
                             <button onclick="askAI('task', ${task.id})" class="tool-btn bg-blue-600/20 text-blue-400 border-blue-500/50 hover:bg-blue-600 hover:text-white" title="Aide Générale">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                        
                        <!-- Footer Carte -->
                        <div class="flex justify-between items-center text-xs">
                            ${task.due_date ? 
                                `<span class="text-gray-400 flex items-center gap-1"><span class="${urgency.badge} px-1.5 rounded">${urgency.text}</span></span>` : 
                                `<span class="text-gray-600">--</span>`}
                            
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="editTask(${task.id})" class="text-blue-400 hover:text-white"><i class="fas fa-pen"></i></button>
                                <button onclick="removeTask(${task.id})" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
            
            updateChart();
            renderFilterButtons();
        }

        function toggleTaskDone(id) {
            const task = tasks.find(t => t.id === id);
            if (task) { task.done = !task.done; saveTasks(); renderTasks(currentFilter); }
        }

        function removeTask(id) {
            if (confirm("Supprimer ?")) { tasks = tasks.filter(t => t.id !== id); saveTasks(); renderTasks(currentFilter); }
        }
        
        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            if (!task || task.done) return;
            editingTaskId = id; 
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskSubject').value = task.subject;
            document.getElementById('taskDescription').value = task.description;
            document.getElementById('taskDueDate').value = task.due_date || ''; 
            document.getElementById('formModalTitle').innerHTML = `Modifier`;
            document.getElementById('formSubmitButton').innerHTML = `Mettre à Jour`;
            openFormModal();
        }

        // --- FORM MODAL ---
        const formModal = document.getElementById('formModal');
        const form = document.getElementById('addHomeworkForm');

        function openFormModal() {
            if (editingTaskId === null) {
                form.reset();
                document.getElementById('formModalTitle').innerHTML = `Nouvelle Tâche`;
                document.getElementById('formSubmitButton').innerHTML = `Enregistrer`;
            }
            formModal.classList.remove('hidden');
            setTimeout(() => { formModal.classList.remove('opacity-0'); form.classList.remove('scale-95'); form.classList.add('scale-100'); }, 10);
        }

        function closeFormModal() {
            formModal.classList.add('opacity-0'); form.classList.remove('scale-100'); form.classList.add('scale-95');
            setTimeout(() => { formModal.classList.add('hidden'); editingTaskId = null; }, 300);
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                subject: document.getElementById('taskSubject').value,
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                due_date: document.getElementById('taskDueDate').value
            };

            if (editingTaskId !== null) {
                const index = tasks.findIndex(t => t.id === editingTaskId);
                if (index !== -1) Object.assign(tasks[index], data);
            } else {
                tasks.push({ id: nextTaskId++, ...data, done: false });
            }
            form.reset(); closeFormModal(); saveTasks(); renderTasks(currentFilter); 
        });

        // --- PROGRESSION ---
        function updateChart() {
            const total = tasks.length;
            const done = tasks.filter(t => t.done).length;
            const pct = total > 0 ? Math.round((done / total) * 100) : 0;

            const chartContainer = document.getElementById('progressionBarContainer');
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div class="mb-2 flex justify-between items-center text-sm font-semibold">
                        <span>${pct}% Terminé</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-3">
                        <div style="width: ${pct}%" class="bg-blue-500 h-3 rounded-full transition-all duration-700 ease-out shadow-lg shadow-blue-500/50"></div>
                    </div>
                `;
            }
            
            // Data for Analysis
            currentChartData = {
                stats: { total, done, remaining: total - done },
                urgent: tasks.filter(t => !t.done && t.due_date).map(t => ({ title: t.title, date: t.due_date })),
                subjects: tasks.reduce((acc, t) => { acc[t.subject] = (acc[t.subject] || 0) + 1; return acc; }, {})
            };
        }
        
        function askAIDashboardAnalysis() {
             askAI('analysis', JSON.stringify(currentChartData)); 
        }

        // --- GESTION CLÉ API ---
        function getApiKey() { return document.getElementById('apiKeyInput').value; }
        function checkApiKey() {
            const input = document.getElementById('apiKeyInput');
            const alert = document.getElementById('apiKeyAlert');
            if (getApiKey().length < 20) { alert.classList.remove('hidden'); input.classList.add('border-red-500'); } 
            else { alert.classList.add('hidden'); input.classList.remove('border-red-500'); }
        }

        // --- INTELLIGENCE ARTIFICIELLE (DUAL MODE) ---
        // Liste Gratuite (Course)
        const FREE_MODELS = [
            "google/gemini-2.0-flash-exp:free", 
            "meta-llama/llama-3.2-3b-instruct:free",
            "mistralai/mistral-7b-instruct:free",
            "microsoft/phi-3-mini-128k-instruct:free"
        ];
        
        // Liste Payante (Prioritaire - Pas cher & Rapide)
        const PREMIUM_MODELS = [
            "google/gemini-flash-1.5", 
            "openai/gpt-4o-mini",
            "meta-llama/llama-3.1-8b-instruct"
        ];
        
        let aiTimerId = null;

        // Fonction fetch unitaire
        async function fetchAI(model, apiKey, systemPrompt, userPrompt) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000); // 20s timeout

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${apiKey}`, 
                        "Content-Type": "application/json", 
                        "HTTP-Referer": window.location.href,
                        "X-Title": "StudentOS"
                    },
                    body: JSON.stringify({ 
                        model, 
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: userPrompt }] 
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!res.ok) throw new Error(`Erreur ${res.status}`);
                
                const data = await res.json();
                if (!data.choices?.[0]) throw new Error('Pas de réponse');
                
                return { model: model, content: data.choices[0].message.content };

            } catch (e) {
                clearTimeout(timeoutId);
                throw e;
            }
        }

        async function askAI(type, inputIdOrData) {
            const apiKey = getApiKey();
            if (!apiKey || apiKey.length < 20) { checkApiKey(); alert("Clé API manquante !"); return; }

            // Récupération de la tâche si nécessaire
            let task = null;
            if (typeof inputIdOrData === 'number') {
                task = tasks.find(t => t.id === inputIdOrData);
                if (!task) return;
            }

            // Construction du Prompt
            let userPrompt = "";
            let systemPrompt = `Tu es un assistant scolaire pour un étudiant au style d'apprentissage ${learningStyle}. Sois encourageant, concis et utilise Markdown.`;

            switch(type) {
                case 'task': 
                    userPrompt = `Aide-moi pour ce devoir : "${task.title}". \nDescription: ${task.description}. \nMatière: ${task.subject}.`;
                    break;
                case 'eli5': 
                    userPrompt = `Explique la consigne suivante comme si j'avais 10 ans (Méthode ELI5). Utilise des analogies simples.\n\nSujet: "${task.title}"\nConsigne: "${task.description}"`;
                    systemPrompt += " Tu es un vulgarisateur de génie comme 'C'est pas sorcier'.";
                    break;
                case 'quiz': 
                    userPrompt = `Génère un mini-quiz de 3 questions de révision (Active Recall) sur le sujet : "${task.title}". \nFormat: Affiche la question, puis utilise une balise spoiler ou demande de cliquer pour voir la réponse.`;
                    systemPrompt += " Tu es un prof interrogateur.";
                    break;
                case 'breakdown': 
                    userPrompt = `Cette tâche me semble trop grosse : "${task.title}". \nDescription: ${task.description}. \nDécoupe-la en 3 à 5 sous-étapes concrètes réalisables en 20 minutes chacune. Présente sous forme de Checklist.`;
                    systemPrompt += " Tu es un coach en productivité spécialisé dans la méthode GTD.";
                    break;
                case 'estimate': 
                    userPrompt = `Combien de temps prendrait un étudiant moyen pour faire ce devoir : "${task.title}" (${task.description}) ? \nDonne une estimation réaliste et pessimiste. Explique pourquoi en 1 phrase.`;
                    break;
                case 'prioritize': 
                    const pendingTasks = tasks.filter(t => !t.done).map(t => ({ id: t.id, title: t.title, subject: t.subject, due: t.due_date }));
                    userPrompt = `Voici ma liste de tâches JSON : ${JSON.stringify(pendingTasks)}. \nQuelle est la tâche UNIQUE que je dois faire maintenant pour avoir le plus d'impact (Matrice Eisenhower) ? Justifie en 1 phrase percutante.`;
                    systemPrompt += " Tu es un général militaire stratège.";
                    break;
                case 'music': 
                    const currentSubject = tasks.find(t => !t.done)?.subject || "Général";
                    userPrompt = `Je vais étudier : ${currentSubject}. \nSuggère-moi un style musical ou d'ambiance précis (ex: LoFi, Jazz, Bruit Marron) pour me concentrer. Donne 3 mots-clés pour chercher sur YouTube/Spotify.`;
                    break;
                case 'analysis':
                    userPrompt = `Analyse mes données : ${inputIdOrData}. Que dois-je travailler en priorité ?`;
                    break;
            }

            // UI Loading
            openModal();
            const contentDiv = document.getElementById('aiContent');
            const loadingDiv = document.getElementById('aiLoading');
            const statusDiv = document.getElementById('aiStatus');
            const timerDisplay = document.getElementById('timerDisplayAI');
            
            contentDiv.innerHTML = '';
            loadingDiv.classList.remove('hidden');
            
            // Sélection des modèles selon le mode
            const activeModels = isPremiumMode ? PREMIUM_MODELS : FREE_MODELS;
            const modeName = isPremiumMode ? "PREMIUM (Payant)" : "GRATUIT (Course)";
            
            statusDiv.innerText = `Lancement en mode ${modeName}...`;
            
            // Timer visuel
            let elapsed = 0;
            if(aiTimerId) clearInterval(aiTimerId);
            aiTimerId = setInterval(() => { elapsed++; timerDisplay.innerText = `${Math.floor(elapsed/60)}:${(elapsed%60).toString().padStart(2,'0')}`; }, 1000);

            // --- LANCEMENT PARALLÈLE (RACE) ---
            try {
                // On crée un tableau de promesses
                const promises = activeModels.map(model => fetchAI(model, apiKey, systemPrompt, userPrompt));
                
                // Le premier qui répond gagne
                const result = await Promise.any(promises);
                
                clearInterval(aiTimerId);
                loadingDiv.classList.add('hidden');
                
                const modelName = result.model.split('/')[1].split(':')[0]; 
                statusDiv.innerHTML = `<span class="text-green-400"><i class="fas fa-bolt"></i> Réponse par : ${modelName}</span>`;
                contentDiv.innerHTML = marked.parse(result.content);

            } catch (aggregateError) {
                console.error("Tous les modèles ont échoué :", aggregateError);
                clearInterval(aiTimerId);
                loadingDiv.classList.add('hidden');
                statusDiv.innerText = "Échec Système";
                
                if (isPremiumMode) {
                    contentDiv.innerHTML = `
                        <div class="p-4 bg-red-900/30 border border-red-500 rounded-lg text-red-200">
                            <h3 class="font-bold">Erreur Mode Premium</h3>
                            <p class="mt-2 text-sm">Vérifiez que vous avez des crédits sur OpenRouter. Si vous n'avez pas payé, repassez en mode GRATUIT.</p>
                        </div>`;
                } else {
                    contentDiv.innerHTML = `
                        <div class="p-4 bg-red-900/30 border border-red-500 rounded-lg text-red-200">
                            <h3 class="font-bold">Saturation Totale (Gratuit)</h3>
                            <p class="mt-2 text-sm">Les modèles gratuits sont surchargés. Réessayez ou passez en mode Premium.</p>
                            <button onclick="askAI('${type}', ${typeof inputIdOrData === 'object' ? JSON.stringify(inputIdOrData).replace(/"/g, '&quot;') : inputIdOrData})" class="mt-4 w-full py-2 bg-red-700 hover:bg-red-600 rounded text-sm font-bold transition">
                                <i class="fas fa-sync-alt animate-spin-slow"></i> Réessayer
                            </button>
                        </div>`;
                }
            }
        }

        // --- MODAL UTILS ---
        const aiModal = document.getElementById('aiModal');
        function openModal() { aiModal.classList.remove('hidden'); setTimeout(() => { aiModal.classList.remove('opacity-0'); aiModal.children[0].classList.add('scale-100'); }, 10); }
        function closeModal() { if(aiTimerId) clearInterval(aiTimerId); aiModal.classList.add('opacity-0'); aiModal.children[0].classList.remove('scale-100'); setTimeout(() => aiModal.classList.add('hidden'), 300); }
        aiModal.onclick = (e) => { if (e.target === aiModal) closeModal(); };

        // --- POMODORO ---
        let timeLeft = 25 * 60, timerId = null;
        function updateDisplay() { 
            const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
            const s = (timeLeft%60).toString().padStart(2,'0');
            document.getElementById('timerDisplay').textContent = `${m}:${s}`;
            document.title = `${m}:${s} - StudentOS`;
        }
        function toggleTimer() {
            const btn = document.getElementById('timerBtn');
            if (timerId) { clearInterval(timerId); timerId = null; btn.innerHTML = '<i class="fas fa-play ml-1"></i>'; btn.classList.replace('bg-yellow-600', 'bg-blue-600'); }
            else { 
                btn.innerHTML = '<i class="fas fa-pause"></i>'; btn.classList.replace('bg-blue-600', 'bg-yellow-600');
                timerId = setInterval(() => { timeLeft--; updateDisplay(); if(timeLeft<=0) { resetTimer(); alert("Pause !"); } }, 1000); 
            }
        }
        function resetTimer() { 
            clearInterval(timerId); timerId = null; timeLeft = 25*60; updateDisplay(); 
            const btn = document.getElementById('timerBtn');
            if(btn) { btn.innerHTML = '<i class="fas fa-play ml-1"></i>'; btn.classList.replace('bg-yellow-600', 'bg-blue-600'); }
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => { loadTasks(); checkApiKey(); renderTasks(); updateLearningStyleUI(); });
    </script>
</body>
</html>